<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Datos LPL</title>
</head>

<body>

    <h1 style="text-align: center;">Registro de Horarios</h1>
    <table id="table" border="1">

    </table>

    <script>
        function getRequest() {
            try {
                var request = new XMLHttpRequest();
            } catch (err) {
                try {
                    var request = ActiveXObject('Msxm12.XMLHTTP');
                } catch (err2) {
                    try {
                        var request = ActiveXObject('Microsoft.EXMLHTTP');
                    } catch (err3) {
                        var request = false;
                    }
                }
            }
            return request;
        }

        function formatTime(date) {
            return `${date.getDate()<10?'0': ''}${date.getDate()}/${date.getMonth()+1<10? '0': ''}${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${date.getMinutes()<10?'0': ''}${date.getMinutes()}:${date.getSeconds()<10?'0': ''}${date.getSeconds()}`
        }

        let html = '';
        let table = document.getElementById('table');

        // table headers
        html += '<tr>';
        html += '    <td>';
        html += '        Móvil';
        html += '    </td>';
        html += '    <td>';
        html += '        Ayudantes';
        html += '    </td>';
        html += '    <td>';
        html += '        Ruta';
        html += '    </td>';
        html += '    <td>';
        html += '        Conductor';
        html += '    </td>';
        html += '    <td>';
        html += '        Salida Base';
        html += '    </td>';
        html += '    <td>';
        html += '        Inicio Ruta';
        html += '    </td>';
        html += '    <td>';
        html += '        Final Ruta';
        html += '    </td>';
        html += '    <td>';
        html += '        Abandono Ruta';
        html += '    </td>';
        html += '    <td>';
        html += '        Salida Relleno';
        html += '    </td>';
        html += '    <td>';
        html += '        Ingreso Relleno';
        html += '    </td>';
        html += '    <td>';
        html += '        Inicio Almuerzo';
        html += '    </td>';
        html += '    <td>';
        html += '        Final Almuerzo';
        html += '    </td>';
        html += '    <td>';
        html += '        Regreso Base';
        html += '    </td>';
        html += '    <td>';
        html += '        Comentarios';
        html += '    </td>';
        html += '    <td>';
        html += '        Modificaciones';
        html += '    </td>';
        html += '</tr>';


        let token;
        if (!sessionStorage.getItem('token')) {
            let loggedIn = false;
            while (!loggedIn) {
                let userName = "";
                while (!userName) {
                    userName = prompt("Nombre de usuario", "");
                }

                let password = "";
                while (!password) {
                    password = prompt("Contraseña", "");
                }

                let loginRequest = getRequest();

                loginRequest.onreadystatechange = () => {
                    if (loginRequest.readyState == 4) {
                        if (loginRequest.status == 200) {
                            let res = JSON.parse(loginRequest.response);
                            token = res.token;
                            sessionStorage.setItem('token', token);
                            loggedIn = true;
                        } else {
                            let res = JSON.parse(loginRequest.response);
                            alert(res.err.message);
                        }
                    }
                };
                let body = {
                    nombreUsuario: userName,
                    contra: password
                };

                loginRequest.open('POST', '/login', false);
                loginRequest.setRequestHeader('Content-Type', 'application/json');
                loginRequest.send(JSON.stringify(body));
            }
        } else {
            token = sessionStorage.getItem('token');
        }
        let dataRequest = getRequest();

        dataRequest.onreadystatechange = () => {
            if (dataRequest.readyState == 4) {
                if (dataRequest.status == 200) {
                    let res = JSON.parse(dataRequest.response);
                    // console.log(res);
                    let regs = res.registros;
                    let counter = 0;
                    regs.forEach(element => {
                        if (counter % 2 == 0) {
                            html += '<tr bgcolor="#b7e1df">';
                        } else {
                            html += '<tr>';
                        }
                        counter++;
                        html += '    <td>';
                        html += `        ${element.registro_de_horario.movil? element.registro_de_horario.movil: '-'}`;
                        html += '    </td>';
                        html += '    <td>';
                        html += `        ${element.registro_de_horario.ayudantes? element.registro_de_horario.ayudantes: '-'}`;
                        html += '    </td>';
                        html += '    <td>';
                        html += `        ${element.registro_de_horario.ruta? element.registro_de_horario.ruta.ruta: '-'}`;
                        html += '    </td>';
                        html += '    <td>';
                        if (element.registro_de_horario.personal) {
                            html += `        ${element.registro_de_horario.personal.idPersonal}-${element.registro_de_horario.personal.nombre}`;
                        } else {
                            html += `        -`;
                        }
                        html += '    </td>';
                        html += '    <td>';
                        html += `        ${element.salidaBase? formatTime(new Date(element.salidaBase)): '-'}`;
                        html += '    </td>';
                        html += '    <td>';
                        html += `        ${element.inicioRuta? formatTime(new Date(element.inicioRuta)): '-'}`;
                        html += '    </td>';
                        html += '    <td>';
                        html += `        ${element.finRuta? formatTime(new Date(element.finRuta)): '-'}`;
                        html += '    </td>';
                        html += '    <td>';
                        html += `        ${element.abandonoRuta? formatTime(new Date(element.abandonoRuta)): '-'}`;
                        html += '    </td>';
                        html += '    <td>';
                        html += `        ${element.salidaRelleno? formatTime(new Date(element.salidaRelleno)): '-'}`;
                        html += '    </td>';
                        html += '    <td>';
                        html += `        ${element.ingresoRelleno? formatTime(new Date(element.ingresoRelleno)): '-'}`;
                        html += '    </td>';
                        html += '    <td>';
                        html += `        ${element.inicioAlmuerzo? formatTime(new Date(element.inicioAlmuerzo)): '-'}`;
                        html += '    </td>';
                        html += '    <td>';
                        html += `        ${element.finalAlmuerzo? formatTime(new Date(element.finalAlmuerzo)): '-'}`;
                        html += '    </td>';
                        html += '    <td>';
                        html += `        ${element.regresoBase? formatTime(new Date(element.regresoBase)): '-'}`;
                        html += '    </td>';
                        html += '    <td>';
                        html += `        ${element.comentarios? element.comentarios: '-'}`;
                        html += '    </td>';
                        html += '    <td>';
                        html += `        ${element.modificaciones? element.modificaciones: '-'}`;
                        html += '    </td>';
                        html += '</tr>';
                    });

                    table.innerHTML = html;
                } else {
                    let res = JSON.parse(dataRequest.response);
                    alert(JSON.stringify(res.err));
                }
            }
        };

        dataRequest.open('GET', 'registroDeHorarios', true);
        dataRequest.setRequestHeader('token', token);
        dataRequest.setRequestHeader('Content-Type', 'application/json');
        dataRequest.send();
    </script>

</body>

</html>